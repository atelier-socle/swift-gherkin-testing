name: CI

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build-and-test:
    name: "macOS (Swift 6.2)"
    runs-on: macos-26
    steps:
      - uses: actions/checkout@v4
      - name: Select Xcode
        run: sudo xcode-select -s /Applications/Xcode_26.2.app
      - name: Swift Version
        run: swift --version
      - name: Build
        run: swift build
      - name: Test with Coverage
        run: swift test --enable-code-coverage
      - name: Coverage Report
        run: |
          PROF_DATA=$(find .build -name "default.profdata" -type f | head -1)
          TEST_BIN=$(find .build -name "swift-gherkin-testingPackageTests" -type f ! -name "*.o" | head -1)
          if [ -n "$PROF_DATA" ] && [ -n "$TEST_BIN" ]; then
            xcrun llvm-cov report "$TEST_BIN" \
              -instr-profile="$PROF_DATA" \
              -ignore-filename-regex='\.build|Tests'
          fi

  platform-builds:
    name: "${{ matrix.platform }}"
    runs-on: macos-26
    strategy:
      matrix:
        include:
          - platform: iOS
            destination: "platform=iOS Simulator,name=iPhone 16,OS=latest"
          - platform: tvOS
            destination: "platform=tvOS Simulator,name=Apple TV,OS=latest"
          - platform: watchOS
            destination: "platform=watchOS Simulator,name=Apple Watch Series 10,OS=latest"
          - platform: visionOS
            destination: "platform=visionOS Simulator,name=Apple Vision Pro,OS=latest"
          - platform: Mac Catalyst
            destination: "platform=macOS,variant=Mac Catalyst"
    steps:
      - uses: actions/checkout@v4
      - name: Select Xcode
        run: sudo xcode-select -s /Applications/Xcode_26.2.app
      - name: Build for ${{ matrix.platform }}
        run: |
          xcodebuild build \
            -scheme swift-gherkin-testing \
            -destination "${{ matrix.destination }}" \
            -skipPackagePluginValidation \
            CODE_SIGNING_ALLOWED=NO